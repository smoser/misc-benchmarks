#!/bin/bash

for p in . ./ftqV110/ftq ./ftq; do
   [ -x "$p/ftq" -a -f "$p/fwq" ] && FTQ_D="$p" && break
done
[ -n "$FTQ_D" ] || { echo "need to set FTQ_D"; exit 1; }

outd="${1:-out.d}"
N="${2:-2000000}"
mhz=$(awk '$0 ~ /cpu MHz/ { print $4; exit(0); }' /proc/cpuinfo )
bits_full=$(echo "l(0.001*$mhz*10^6/380)/l(2)" | bc -l)
bits_floor=${bits_full%.*}

out_d="$1"
mkdir -p "$outd"
lscpu > "$outd/lscpu"
threads=$(awk '$0 ~ /^Thread.* per core/ { print $4 }' "$outd/lscpu")
cores=$(awk '$0 ~ /^Core.* per socket/ { print $4 }' "$outd/lscpu")
sockets=$(awk '$0 ~ /^Socket.*/ { print $2 }' "$outd/lscpu")
printf "mhz=%s threads=%s cores=%s sockets=%s bits=%s\n" \
   "$mhz" "$threads" "$cores" "$sockets" "$bits_full" > "$outd/info"
printf "%s\n" "kernel=$(uname -r)" >> "$outd/info"
if [ -f /etc/redhat-release ]; then
   echo "release=$(cat /etc/redhat-release)" >> "$outd/info"
else
   echo "release=$(lsb_release -sc)" >> "$outd/info"
fi
cat /proc/cpuinfo > "${outd}/cpuinfo"

run() {
   local st=${SECONDS} ret=0 bflag="-w"
   local prog="$1" outd="$2" bits="$3" n="$4" threads="$5" cmd=""
   cmd=( )
   pre="$outd/${prog}-$bits-$N${threads:+-${threads}}/run"
   case "$prog" in
      ftq|tftq) bflag="-i";;
   esac
   cmd=( "$prog" -o "$pre" "$bflag" "$bits" -n "$N"
         ${threads:+-n ${threads}} )
   mkdir -p "${pre%/*}"
   echo "${cmd[@]}" 1>&2
   "${cmd[@]}"
   ret=$?
   echo "$ret: [$(($SECONDS-$st))s]"
   return $ret
}

PATH=$FTQ_D:$PATH

nthreads=$(($threads*$cores*$sockets))
[ "$nthreads" == "1" ] && nthreads=2

cat "$outd/info"
sstart=${SECONDS}
for bits in ${bits_floor} $((${bits_floor}+1)); do
   run ftq "$outd" "$bits" "$N"
   run fwq "$outd" "$bits" "$N"
   run t_fwq "$outd" "$bits" "$N" "$nthreads"
   run t_fwq "$outd" "$bits" "$N" "$nthreads"
done
end=${SECONDS}
echo "took $(($end-$sstart))s"
